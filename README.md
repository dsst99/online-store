 Online Store
--------------------------------------------------------------------------------------------------------------

| Раздел              | Функционал                                                                        |
|---------------------|-----------------------------------------------------------------------------------| 
|  Каталог          | Категории и товары с поиском, фильтрами и кэшированием                              |
|  Аутентификация | Регистрация, вход по JWT, обновление access-токена (refresh)                          |
|  Заказы           | Оформление заказов, проверка stock, пересчёт total_price, история статусов          |
|  Асинхронные задачи | Генерация PDF и эмуляция отправки писем, интеграция с внешним API (Celery + Redis)|
| ️ Кэширование     | Memcached для списков и деталей                                                     |
|  Админ-интерфейс | Просмотр заказов с фильтрами по статусам и пользователям                             |
|  Документация API | Swagger / Redoc                                                                     |
|  Тесты             | Покрытие API с использованием pytest                                               |
---------------------------------------------------------------------------------------------------------------

Django + DRF + Celery + Memcached
-------------------------------------------------------------------------

Стек
-------------------------------------------------------------------------

- Django 5.x + DRF — REST API

- PostgreSQL (prod) / SQLite (dev)

- Redis + Celery — фоновые задачи (PDF, уведомления)

- Memcached — кэширование списков и деталей

- JWT (SimpleJWT) — аутентификация

- drf-spectacular — OpenAPI / Swagger / Redoc

- pytest + pytest-django — тесты

-------------------------------------------------------------------------
Быстрый запуск (локально)

# Виртуальное окружение и зависимости

| Команда                           | Описание                         |
|-----------------------------------|----------------------------------|
| `python -m venv .venv`            | Создание виртуального окружения  |
| `source .venv/bin/activate`       | Активация виртуального окружения |
| `pip install -r requirements.txt` | Установка зависимостей проекта   |

-------------------------------------------------------------------------

# Миграции и суперпользователь

| Команда                            | Описание                          |
|------------------------------------|-----------------------------------|
| `python manage.py migrate`         | Применение миграций к базе данных |
| `python manage.py createsuperuser` | Создание суперпользователя        |

---------------------------------------------------------------------------

# Параллельно запустить сервисы

| Команда                                 | Описание                                |
|-----------------------------------------|-----------------------------------------|
| `redis-server`                          | Запуск Redis (брокер для Celery)        |
| `memcached -vv`                         | Запуск Memcached (кэширование)          |
| `celery -A online_store worker -l info` | Запуск Celery воркера для фоновых задач |
| `python manage.py runserver`            | Запуск Django сервера                   |

--------------------------------------------------------------------------------------
Docker Compose

# Сборка и запуск

| Команда                     | Описание                    |
|-----------------------------|-----------------------------|
| `docker compose up --build` | Сборка и запуск контейнеров |

--------------------------------------------------------------
Entrypoint и локальные настройки кэша

| Шаг | Описание |
|-----|----------|
| 1   | Ждёт готовности сервисов: Postgres, Redis и Memcached |
| 2   | Применяет миграции: `python manage.py migrate` |
| 3   | Запускает Django сервер (`runserver`) или Celery воркер |
| 4   | Для локальной разработки используется Memcached: `127.0.0.1:11211` |
| 5   | Обеспечивает корректный порядок старта контейнеров web и worker |
| 6   | Не изменять файл без понимания логики запуска, иначе может нарушиться старт сервисов |
------------------------------------------------------------------------------------------------

# Миграции и суперпользователь

| Команда                                                    | Описание                                |
|------------------------------------------------------------|-----------------------------------------|
| `docker compose exec web python manage.py migrate`         | Применение миграций в контейнере        |
| `docker compose exec web python manage.py createsuperuser` | Создание суперпользователя в контейнере |

---------------------------------------------------------------------------------------------------------
 Ключевые настройки

AUTH_USER_MODEL = "users.User"

REST_FRAMEWORK["DEFAULT_AUTHENTICATION_CLASSES"] = (
"rest_framework_simplejwt.authentication.JWTAuthentication",
)

CACHES = {
"default": {
"BACKEND": "django.core.cache.backends.memcached.PyMemcacheCache",
"LOCATION": "127.0.0.1:11211",
}
}

--------------------------------------------------------------------------------------------------
 API
Users (apps/users)
| Endpoint | Method | Description |
| ------------------------ | ------ | --------------------------------------- |
| `/api/v1/auth/register/` | POST | Регистрация {username, email, password} |
| `/api/v1/auth/login/`    | POST | JWT {access, refresh} |
| `/api/v1/auth/refresh/`  | POST | Обновление access по refresh |
-------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------
Catalog
| Endpoint | Method | Description |
| ------------------------------------- | ------ | ---------------------------------------------------- |
| `/api/v1/categories/?search=`         | GET | Список активных категорий, кэш 5 мин |
| `/api/v1/categories/{id}/`            | GET | Деталь категории, кэш 5 мин |
| `/api/v1/categories/{id}/?hard=true`  | DELETE | Hard delete — только админ и без связанных продуктов |
| `/api/v1/products/?search=&category=` | GET | Список активных продуктов, кэш 5 мин |
| `/api/v1/products/{id}/`              | GET | Деталь продукта, кэш 5 мин |
---------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------
Orders (JWT required)
| Endpoint | Method | Description |
| ----------------------- | ------ | ---------------------------------------------------------------------- |
| `/api/v1/orders/`       | GET | Список заказов пользователя, кэш 60с |
| `/api/v1/orders/`       | POST | Создание заказа (транзакция, select\_for\_update, Celery: PDF + email) |
| `/api/v1/orders/{id}/`  | GET | Деталь заказа (владелец/админ), кэш 60с |
| `/api/v1/orders/{id}/`  | PATCH | Смена статуса (валидные переходы; shipped → Celery API call)           |
| `/api/v1/admin/orders/` | GET | Админ-список заказов с фильтрами, кэш 60с |
-------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------
Пример ошибки stock (HTTP 400):
{
"stock": "Недостаточно товара на складе",
"details": [{"product_id": 1, "available": 2, "requested": 5}]
}

----------------------------------------------------------------
 Документация

| Endpoint                  | Описание       |
|---------------------------|----------------|
| `/api/schema/`            | OpenAPI schema |
| `/api/schema/swagger-ui/` | Swagger UI     |
| `/api/schema/redoc/`      | Redoc          |

----------------------------------------------------------------

 Реализовано

- Каталог: модели, API, фильтры, кэш, сигналы, тесты

- Заказы: модели, транзакции, select_for_update, API, Celery-задачи, кэш, тесты

- JWT: регистрация, логин, refresh

- drf-spectacular: Swagger / Redoc

- pytest: каталог, заказы, users + auth flow

--------------------------------------------------------------------------------------------------

 Тесты

Централизованные фикстуры пользователей: корневой conftest.py (уникальные email, get_user_model())


--------------------------------------------------------------------------------------------------

| Команда                   | Описание                                             |
|---------------------------|------------------------------------------------------|
| `pytest -q`               | Запуск всех тестов                                   |
| `pytest apps/catalog/ -q` | Запуск тестов каталога                               |
| `pytest apps/orders/ -q`  | Запуск тестов заказов                                |
| `pytest apps/users/ -q`   | Тесты регистрации, логина, refresh и доступ к orders |

--------------------------------------------------------------------------------------------------
